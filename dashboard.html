<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Cabinet - Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,600&family=Kanit:wght@300;400;500&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
      /* ================= CSS Styles ================= */
      :root {
          --phyathai-light-green: #2f6f5e;
          --card-bg: rgba(255, 255, 255, 0.95);
          --accent-orange: #ff9f43;
          --accent-green: #2ecc71;
          --text-main: #2f3542;
          --accent-pink: #f78fb3;
          --accent-purple: #9b59b6;
          --accent-blue: #74b9ff;
      }

      body {
          font-family: 'Kanit', sans-serif;
          background: linear-gradient(-45deg, #a1c4fd, #c2e9fb, #fbc2eb, #f6d365);
          background-size: 400% 400%;
          animation: gradientBG 15s ease infinite;
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
          padding: 20px;
      }

      @keyframes gradientBG {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
      }

      body::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
          pointer-events: none;
          z-index: -1;
      }

      .header-title {
          font-family: 'Cormorant Garamond', serif;
          font-weight: 600;
          font-style: italic;
          color: #2c3e50;
          text-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .top-bar {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 12px;
          margin-top: 10px;
          flex-wrap: wrap;
      }

      .creator-badge, .collab-badge {
          font-family: 'Outfit', sans-serif;
          font-size: 0.75rem;
          letter-spacing: 1.5px;
          text-transform: uppercase;
          background: rgba(255, 255, 255, 0.4);
          padding: 7px 18px;
          border-radius: 999px;
          color: #444;
          display: flex;
          align-items: center;
          height: 40px;
          backdrop-filter: blur(5px);
      }

      .collab-badge span {
          color: var(--phyathai-light-green);
          font-weight: 700;
          margin-left: 6px;
      }

      .medicine-card {
          background: var(--card-bg);
          border-radius: 24px;
          padding: 25px;
          position: relative;
          overflow: hidden;
          border: 1px solid rgba(255, 255, 255, 0.8);
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
          min-height: 220px;
          display: flex;
          flex-direction: column;
          justify-content: center;
      }

      .medicine-card:hover {
          transform: translateY(-4px);
          background: #fff;
          box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
          border-color: #fff;
          transition: 0.3s;
      }

      .slot-indicator {
          font-family: 'Cormorant Garamond', serif;
          font-size: 6rem;
          font-weight: bold;
          font-style: italic;
          color: rgba(0, 0, 0, 0.03);
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          z-index: 0;
          pointer-events: none;
      }

      .slot-badge-label {
          position: absolute;
          top: 0;
          left: 0;
          background: #2f3640;
          color: #fff;
          padding: 5px 15px 5px 20px;
          border-bottom-right-radius: 15px;
          font-family: 'Outfit', sans-serif;
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          z-index: 2;
      }

      .card-content {
          z-index: 1;
          padding-left: 5px;
          padding-right: 5px;
          margin-bottom: 30px;
          text-align: center;
          width: 100%;
      }

      .med-name {
          font-family: 'Kanit', sans-serif;
          font-weight: 500;
          font-size: 1.35rem;
          color: var(--text-main);
          margin-bottom: 4px;
      }

      .med-detail {
          font-family: 'Outfit', sans-serif;
          font-size: 0.9rem;
          color: #7f8c8d;
      }

      .med-detail-list {
          background: rgba(240, 242, 245, 0.6);
          border-radius: 12px;
          padding: 10px;
          margin-top: 8px;
          text-align: left;
          font-size: 0.85rem;
          border: 1px solid rgba(0, 0, 0, 0.05);
          display: inline-block;
          min-width: 85%;
      }

      .med-detail-row {
          margin-bottom: 3px;
          display: flex;
          justify-content: space-between;
      }

      .med-detail-label {
          font-weight: 600;
          color: #636e72;
          margin-right: 8px;
          white-space: nowrap;
      }

      .med-detail-value {
          color: #2d3436;
          text-align: right;
          word-break: break-word;
      }

      .btn-fab {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          border: none;
          background: #f1f2f6;
          color: #2f3542;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: 0.2s;
          cursor: pointer;
          z-index: 5;
          position: absolute;
          bottom: 20px;
          right: 20px;
      }

      .btn-fab:hover {
          background: var(--accent-orange);
          color: #fff;
          box-shadow: 0 5px 15px rgba(255, 159, 67, 0.6);
      }

      .btn-fab-add {
          background: #e8f5e9;
          color: var(--accent-green);
      }

      .btn-fab-add:hover {
          background: var(--accent-green);
          color: #fff;
          box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
      }

      .btn-fab-delete {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          border: 1px solid #fab1a0;
          background: rgba(255, 255, 255, 0.8);
          color: #e17055;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 5;
          transition: 0.2s;
          font-size: 0.8rem;
          position: absolute;
          top: 15px;
          right: 15px;
      }

      .btn-fab-delete:hover {
          background: #e17055;
          color: white;
          border-color: #e17055;
      }

      .footer-credit {
          margin-top: 40px;
          font-family: 'Cormorant Garamond', serif;
          font-style: italic;
          color: #fff;
          text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
          opacity: 0.8;
      }

      .glam-modal {
          position: relative;
          overflow: hidden;
          border-radius: 20px;
          background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.75));
          backdrop-filter: blur(18px);
          border: 1px solid rgba(255, 255, 255, 0.7);
          box-shadow: 0 18px 40px rgba(0, 0, 0, 0.18);
      }

      .glam-modal-title {
          font-family: 'Cormorant Garamond', serif;
          font-size: 1.4rem;
          font-style: italic;
          color: #2d3436;
      }

      .glam-select {
          border-radius: 18px;
          border: 1px solid rgba(255, 255, 255, 0.9);
          background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.8));
          font-family: 'Kanit', sans-serif;
          font-size: 0.95rem;
          padding: 12px 16px;
          appearance: none;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%232c3e50' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 16px center;
          background-size: 16px;
          padding-right: 40px;
          cursor: pointer;
      }

      .btn-manage-list {
          border-radius: 999px;
          border: 1px solid rgba(255, 255, 255, 0.85);
          background: rgba(255, 255, 255, 0.35);
          font-family: 'Kanit', sans-serif;
          font-size: 0.75rem;
          text-transform: uppercase;
          height: 40px;
          padding: 7px 16px;
          transition: all 0.2s;
      }

      .btn-add-med {
          background: rgba(46, 204, 113, 0.15);
          color: #27ae60;
          border: 1px solid rgba(46, 204, 113, 0.3);
      }

      .btn-add-med:hover {
          background: #27ae60;
          color: white;
          box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
      }

      .btn-glam-primary {
          border-radius: 999px;
          padding-inline: 26px;
          font-family: 'Outfit', sans-serif;
          font-weight: 500;
          border: none;
          background: linear-gradient(120deg, var(--accent-pink), var(--accent-orange));
          color: #fff;
          box-shadow: 0 8px 20px rgba(244, 127, 89, 0.55);
      }

      .btn-glam-secondary {
          border-radius: 999px;
          padding-inline: 22px;
          font-family: 'Outfit', sans-serif;
          font-weight: 500;
          border: 1px solid rgba(255, 255, 255, 0.8);
          background: rgba(255, 255, 255, 0.6);
      }

      .btn-glam-danger {
          border-radius: 999px;
          padding-inline: 22px;
          font-family: 'Outfit', sans-serif;
          font-weight: 500;
          border: 1px solid rgba(255, 255, 255, 0.8);
          background: #ff7675;
          color: white;
          box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
      }

      .btn-glam-danger:hover {
          background: #d63031;
          color: white;
      }

      .btn-logout {
          background: rgba(231, 76, 60, 0.15);
          color: #c0392b;
          border: 1px solid rgba(231, 76, 60, 0.3);
          transition: all 0.2s;
      }

      .btn-logout:hover {
          background: #c0392b;
          color: white;
      }

      .user-edit-badge {
          background: rgba(116, 185, 255, 0.15);
          color: #0984e3;
          font-size: 0.7rem;
          padding: 2px 8px;
          border-radius: 12px;
          display: inline-block;
          margin-top: 5px;
          border: 1px solid rgba(116, 185, 255, 0.3);
          max-width: 100%;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }

      /* ================= CSS สำหรับการสั่งปริ้นแบบ A4 (Layout 6 ยาต่อหน้า) ================= */
      @media print {
          body * { visibility: hidden; }
         
          body.printing-a4 #printA4Container,
          body.printing-a4 #printA4Container * { visibility: visible; }
          body.printing-a4 #printA4Container {
              position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white;
          }

          .btn-close, .modal-footer { display: none !important; }

          .a4-page {
              width: 210mm;
              height: 296mm;
              display: grid;
              grid-template-columns: 1fr 1fr;
              grid-template-rows: repeat(3, 1fr);
              gap: 5mm;
              padding: 10mm;
              box-sizing: border-box;
              background: white;
              page-break-after: always;
          }
         
          .print-cell {
              border: 1px dashed #aaa;
              display: flex;
              flex-direction: column;
              justify-content: space-between;
              padding: 6mm;
              box-sizing: border-box;
              max-height: 90mm;
              overflow: hidden;
              font-family: 'Kanit', sans-serif;
          }

          .print-header-row {
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              width: 100%;
              margin-bottom: 5px;
          }

          .print-info-left {
              font-size: 0.8rem;
              color: #333;
              line-height: 1.4;
              text-align: left;
          }
          .print-info-left strong {
              font-weight: 600;
              color: var(--phyathai-light-green);
              font-size: 0.95rem;
          }

          .qrcode-container { margin: 0; }
          .qrcode-container img { display: block; }

          .print-med-box {
              border: 2px solid #333;
              padding: 8px;
              text-align: center;
              margin: 8px auto;
              width: 95%;
              border-radius: 4px;
              background: #f8f9fa;
              flex-grow: 1;
              display: flex;
              align-items: center;
              justify-content: center;
          }
          
          .print-med-name {
              font-weight: bold;
              font-size: 1.25rem;
              margin: 0;
              word-break: break-word;
          }

          .print-barcode-container {
              text-align: center;
              width: 100%;
              margin-top: 8px;
          }
      }
  </style>
</head>

<body>
  <div class="text-center mb-3 mt-4">
      <h1 class="header-title display-3">Medicine Cabinet</h1>

      <div class="top-bar">
          <div class="creator-badge">
              DESIGNED BY
              <span style="color:#d35400; font-weight:700; margin-left:6px;">BME KMUTNB</span>
          </div>

          <div class="collab-badge">
              Collaborated with
              <span>Phyathai 3 Hospital</span>
          </div>

          <button class="btn btn-sm btn-manage-list btn-add-med" onclick="goToAddMedicine()">
              <i class="fas fa-plus-square me-1"></i> เพิ่มข้อมูลยาใหม่
          </button>

          <button class="btn btn-sm btn-manage-list" onclick="openManageMedList()">
              <i class="fas fa-list-ul me-1"></i> รายชื่อยา
          </button>

          <button class="btn btn-sm btn-manage-list btn-logout ms-2" onclick="logout()">
              <i class="fas fa-sign-out-alt me-1"></i> ออกจากระบบ
          </button>
      </div>

      <div id="currentUserDisplay" class="mt-2 text-muted" style="font-family:'Outfit'; font-size:0.9rem;">
          กำลังโหลดข้อมูลผู้ใช้...
      </div>
  </div>

  <div class="container" style="max-width: 900px;">
      <div class="row g-4" id="slotContainer">
      </div>

      <div class="d-flex justify-content-center gap-4 mt-5">
          <button class="btn btn-glam-primary rounded-pill px-4" onclick="addSlot()">
              <i class="fas fa-plus-circle me-2"></i> เพิ่ม Slot
          </button>
      </div>
  </div>

  <div class="footer-credit text-center">Biomedical Engineering Project</div>

  <div class="modal fade" id="selectMedModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content glam-modal">
              <div class="modal-header" style="border-bottom:none;">
                  <h5 class="modal-title glam-modal-title">เลือกชื่อยา</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <label class="form-label mb-2" style="font-family:'Outfit';font-size:0.8rem;text-transform:uppercase;">Select from list</label>
                  <select id="medList" class="form-select glam-select"></select>
              </div>
              <div class="modal-footer" style="border-top:none;">
                  <button class="btn btn-glam-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                  <button class="btn btn-glam-primary" onclick="applySelectedMed()">บันทึก</button>
              </div>
          </div>
      </div>
  </div>

  <div class="modal fade" id="manageMedModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
          <div class="modal-content glam-modal">
              <div class="modal-header" style="border-bottom:none;">
                  <h5 class="modal-title glam-modal-title text-center">จัดการรายชื่อยา</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                  <div class="d-flex align-items-center mb-2 px-3 pb-2 border-bottom">
                      <input type="checkbox" id="selectAllCheckbox" class="form-check-input me-2" onchange="toggleSelectAll()">
                      <label for="selectAllCheckbox" class="form-label mb-0 small text-muted">เลือกทั้งหมด</label>
                     
                      <button class="btn btn-sm btn-outline-primary ms-auto" onclick="prepareA4Print()" style="border-radius: 999px;">
                          <i class="fas fa-print"></i> พิมพ์ใบสั่งยาที่เลือก (A4)
                      </button>
                  </div>

                  <div style="max-height: 450px; overflow-y: auto;">
                      <ul id="medListManager" class="list-group" style="background:none;">
                          <li class="list-group-item text-center text-muted">รอการสแกน...</li>
                      </ul>
                  </div>
              </div>
              <div class="modal-footer d-flex justify-content-between" style="border-top:none;">
                  <button class="btn btn-glam-danger" onclick="deleteSelectedMedicines()">
                      <i class="fas fa-trash-alt me-1"></i> ลบรายการที่เลือก
                  </button>
                  <button class="btn btn-glam-secondary" data-bs-dismiss="modal">ปิด</button>
              </div>
          </div>
      </div>
  </div>

  <div id="printA4Container" style="display: none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getDatabase, ref, set, get, child, onValue, push, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

      const firebaseConfig = {
          apiKey: "AIzaSyCEDJ0GGOqxPGik5huW9XdNEgcnlMs_ebM",
          authDomain: "slot-drug.firebaseapp.com",
          databaseURL: "https://slot-drug-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "slot-drug",
          storageBucket: "slot-drug.firebasestorage.app",
          messagingSenderId: "805318911272",
          appId: "1:805318911272:web:d5c569063937d56eb01c1d",
          measurementId: "G-RGG20ZR8J0"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      let globalSlots = [];
      let currentSlotIndex = null;
      let currentUserName = "Loading...";

      let medDataMap = {};

      window.goToAddMedicine = function () {
          window.location.href = "add_medicine.html";
      };

      // --- Authentication & User Info ---
      onAuthStateChanged(auth, (user) => {
          if (user) {
              const userRef = ref(db, 'users/' + user.uid);
              get(userRef).then((snapshot) => {
                  let displayName = "";
                  if (snapshot.exists() && snapshot.val().name) {
                      displayName = snapshot.val().name;
                  } else if (user.displayName) {
                      displayName = user.displayName;
                  } else {
                      displayName = user.email;
                  }
                  currentUserName = displayName;
                  document.getElementById("currentUserDisplay").innerHTML =
                  `<span style="font-family: 'Kanit', sans-serif;"><i class="fas fa-user-circle me-1"></i> ผู้ใช้งาน: <strong>${currentUserName}</strong></span>`;
                  loadSlotsFromFirebase();
                  loadMedListFromFirebase();
              }).catch((error) => {
                  currentUserName = user.email || "Unknown User";
                  loadSlotsFromFirebase();
                  loadMedListFromFirebase();
              });
          } else {
              window.location.href = "index.html";
          }
      });

      window.logout = function () {
          signOut(auth).then(() => { window.location.href = "index.html"; }).catch((error) => { alert("Logout Failed"); });
      };

      // --- Medicine List Logic ---
      const medListRef = ref(db, 'drugs');
      function loadMedListFromFirebase() {
          onValue(medListRef, (snapshot) => {
              const select = document.getElementById("medList");
              const ul = document.getElementById("medListManager");

              select.innerHTML = "";
              ul.innerHTML = "";
              medDataMap = {};

              let hasData = false;

              if (snapshot.exists()) {
                  hasData = true;
                  const data = snapshot.val();
                  Object.keys(data).forEach((key) => {
                      const drugItem = data[key];
                      const drugName = drugItem.name ? drugItem.name : key;

                      if (!drugItem.hospitalCode) {
                          drugItem.hospitalCode = key;
                      }

                      medDataMap[drugName] = drugItem;

                      // ===== จุดที่แก้ไข: กำหนดให้แสดงแค่ชื่อยาใน Dropdown =====
                      const opt = document.createElement("option");
                      opt.value = drugName;
                     
                      // ถ้าในฐานข้อมูลมีวงเล็บติดมากับชื่อยาด้วย เราจะตัดออกให้เหลือแค่ชื่อ (เช่น CYTOTEC)
                      let cleanName = drugName.split(' [รหัส:')[0];
                      opt.textContent = cleanName;
                     
                      select.appendChild(opt);
                      // =======================================================

                      const generic = drugItem.genericName || '-';
                      const form = drugItem.dosageForm || '-';
                      const strength = drugItem.strength || '-';
                   
                      const li = document.createElement("li");
                      li.className = "list-group-item d-flex justify-content-between align-items-center mb-2";
                      li.style.background = "rgba(255,255,255,0.7)";
                      li.style.border = "none";

                      li.innerHTML = `
                      <div class="d-flex align-items-start" style="width: 100%;">
                          <input type="checkbox" class="med-checkbox form-check-input mt-1 me-3" value="${key}">
                          <div class="flex-grow-1">
                              <div class="fw-bold text-primary mb-0">${cleanName}</div>
                              <div class="text-secondary small fst-italic mb-1">${generic}</div> <div class="text-muted small" style="font-size: 0.8rem; line-height: 1.5;">
                                  <span class="d-inline-block me-2 border rounded px-1 bg-light">รูปแบบ: ${form}</span>
                                  <span class="d-inline-block me-2 border rounded px-1 bg-light">ขนาด: ${strength}</span>
                              </div>
                          </div>
                      </div>
                      <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteMedicine('${key}')" title="ลบรายการนี้">
                          <i class="fas fa-trash"></i>
                      </button>`;
                      ul.appendChild(li);
                  });
              }
              if (!hasData) ul.innerHTML = '<li class="list-group-item text-center text-muted">ไม่พบข้อมูลยา</li>';
          });
      }

      window.deleteMedicine = function (key) {
          if (confirm("ต้องการลบยาออกหรือไม่?")) {
              remove(ref(db, 'drugs/' + key)).catch((error) => { alert("ลบไม่สำเร็จ"); });
          }
      };

      window.openManageMedList = function () {
          const selectAll = document.getElementById('selectAllCheckbox');
          if (selectAll) selectAll.checked = false;
          new bootstrap.Modal(document.getElementById('manageMedModal')).show();
      };

      window.toggleSelectAll = function () {
          const isChecked = document.getElementById('selectAllCheckbox').checked;
          const checkboxes = document.querySelectorAll('.med-checkbox');
          checkboxes.forEach(cb => {
              cb.checked = isChecked;
          });
      }

      window.deleteSelectedMedicines = function () {
          const checkedBoxes = document.querySelectorAll('.med-checkbox:checked');
          if (checkedBoxes.length === 0) {
              alert("กรุณาเลือกรายการยาที่ต้องการลบอย่างน้อย 1 รายการ");
              return;
          }
          if (confirm(`⚠️ ยืนยันการลบยา ${checkedBoxes.length} รายการที่เลือก? \n(ไม่สามารถกู้คืนได้)`)) {
              checkedBoxes.forEach(cb => {
                  const keyToDelete = cb.value;
                  remove(ref(db, 'drugs/' + keyToDelete))
                      .catch(err => console.error("Error deleting " + keyToDelete, err));
              });
              document.getElementById('selectAllCheckbox').checked = false;
          }
      }

      // --- Slot Logic ---
      function loadSlotsFromFirebase() {
          onValue(ref(db, "slots"), (snapshot) => {
              if (snapshot.exists()) {
                  const data = snapshot.val();
                  globalSlots = Array.isArray(data) ? data.filter(x => x !== null) : Object.values(data);
              } else {
                  globalSlots = [];
              }
              renderSlots();
          });
      }

      function renderSlots() {
          const container = document.getElementById("slotContainer");
          container.innerHTML = "";
          globalSlots.forEach((s, index) => {
              const filled = s.name !== "Empty Slot";
              const displayNum = String(index + 1).padStart(2, '0');
              const createdTime = s.createdAt ? `<div class="text-muted mt-2" style="font-size:0.75rem"><i class="far fa-clock me-1"></i> ${s.createdAt}</div>` : '';
              const editorInfo = s.editedBy ? `<div class="user-edit-badge" title="Last edited by ${s.editedBy}"><i class="fas fa-user-edit me-1"></i> ${s.editedBy}</div>` : '';

              let detailHtml = `<div class="med-detail">${s.detail}</div>`;
              let cleanSlotName = s.name.split(' [รหัส:')[0];

              const cardHTML = `
                  <div class="col-md-6">
                      <div class="medicine-card" id="card-${index}" style="${filled ? "" : "border-style:dashed;background:rgba(255,255,255,0.4);"}">
                          <div class="btn-fab-delete" onclick="deleteSpecificSlot(${index})" title="ลบ Slot นี้"><i class="fas fa-trash"></i></div>
                          <div class="slot-badge-label" style="${filled ? "" : "background:#95a5a6;"}">SLOT ${displayNum}</div>
                          <div class="slot-indicator">${displayNum}</div>
                          <div class="card-content">
                              <div class="med-name" style="${filled ? "" : "color:#95a5a6;font-style:italic;"}">${cleanSlotName}</div>
                              ${detailHtml}
                              ${createdTime} ${editorInfo}
                          </div>
                          <button class="btn-fab ${filled ? "" : "btn-fab-add"}" onclick="editMedicine(${index})">
                              <i class="fas ${filled ? "fa-pen" : "fa-plus"}"></i>
                          </button>
                      </div>
                  </div>`;
              container.insertAdjacentHTML('beforeend', cardHTML);
          });
      }

      window.saveToFirebase = function () {
          globalSlots.forEach((item, index) => { if (item) item.slot = index + 1; });
          set(ref(db, "slots"), globalSlots).catch((error) => { alert("บันทึกไม่สำเร็จ"); });
      }

      window.addSlot = function () {
          const now = new Date().toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
          globalSlots.push({ slot: globalSlots.length + 1, name: "Empty Slot", detail: "Available for new item", createdAt: now, editedBy: currentUserName, hospitalCode: "" });
          saveToFirebase();
      };

      window.removeLastSlot = function () { if (globalSlots.length > 0) { globalSlots.pop(); saveToFirebase(); } };
      window.deleteSpecificSlot = function (index) { if (confirm("ต้องการลบ Slot นี้?")) { globalSlots.splice(index, 1); saveToFirebase(); } };
      window.editMedicine = function (index) { currentSlotIndex = index; new bootstrap.Modal(document.getElementById('selectMedModal')).show(); };

      window.applySelectedMed = function () {
          const selectedName = document.getElementById("medList").value;
          const drugInfo = medDataMap[selectedName];

          if (globalSlots[currentSlotIndex]) {
              globalSlots[currentSlotIndex].name = selectedName;

              if (drugInfo) {
                  const generic = drugInfo.genericName || '-';
                  const form = drugInfo.dosageForm || '-';
                  const strength = drugInfo.strength || '-';

                  globalSlots[currentSlotIndex].hospitalCode = drugInfo.hospitalCode || drugInfo.code || '';
                  globalSlots[currentSlotIndex].tradeName = drugInfo.tradeName || selectedName;

                  globalSlots[currentSlotIndex].detail = `
                      <div class="med-detail-list">
                          <div class="med-detail-row">
                              <span class="med-detail-label">ชื่อสามัญ:</span>
                              <span class="med-detail-value" style="font-style:italic;">${generic}</span>
                          </div>
                          <div class="med-detail-row">
                              <span class="med-detail-label">รูปแบบ:</span>
                              <span class="med-detail-value">${form}</span>
                          </div>
                          <div class="med-detail-row">
                              <span class="med-detail-label">ขนาด:</span>
                              <span class="med-detail-value">${strength}</span>
                          </div>
                      </div>
                  `;
              } else {
                  globalSlots[currentSlotIndex].hospitalCode = '';
                  globalSlots[currentSlotIndex].tradeName = '';
                  globalSlots[currentSlotIndex].detail = '<span class="text-success small">● Ready to dispense</span>';
              }

              globalSlots[currentSlotIndex].createdAt = new Date().toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });
              globalSlots[currentSlotIndex].editedBy = currentUserName;
              saveToFirebase();
          }
          bootstrap.Modal.getInstance(document.getElementById('selectMedModal')).hide();
      };

      // ================= ฟังก์ชันปริ้นรวม A4 (Batch Print) =================
      window.prepareA4Print = function() {
          const checkedBoxes = document.querySelectorAll('.med-checkbox:checked');
         
          if (checkedBoxes.length === 0) {
              alert("กรุณาเลือกยาอย่างน้อย 1 รายการเพื่อพิมพ์");
              return;
          }

          const printContainer = document.getElementById('printA4Container');
          printContainer.innerHTML = '';
          printContainer.style.display = "block";

          let currentPage = document.createElement('div');
          currentPage.className = 'a4-page';
          printContainer.appendChild(currentPage);

          let itemCount = 0;

          checkedBoxes.forEach((cb, index) => {
              const fullDrugName = cb.closest('li').querySelector('.text-primary').innerText;
              const drugName = fullDrugName.split(' [รหัส:')[0]; // ทำความสะอาดชื่อยาก่อนพิมพ์
              const drugInfo = medDataMap[fullDrugName];
              const hCode = (drugInfo && drugInfo.hospitalCode) ? drugInfo.hospitalCode : 'NO-CODE';

              if (itemCount > 0 && itemCount % 6 === 0) {
                  currentPage = document.createElement('div');
                  currentPage.className = 'a4-page';
                  printContainer.appendChild(currentPage);
              }

              const cell = document.createElement('div');
              cell.className = 'print-cell';
             
              const idBarcode = `barcode-a4-${index}`;
              const idQrcode = `qrcode-a4-${index}`;

              cell.innerHTML = `
                  <div class="print-header-row">
                      <div class="print-info-left">
                          <strong>Phyathai 3 Hospital</strong><br>
                          Medicine Cabinet Project<br>
                          Printed by: ${currentUserName}
                      </div>
                      <div class="print-code-container qrcode-container" id="${idQrcode}"></div>
                  </div>

                  <div class="print-med-box">
                      <div class="print-med-name">${drugName}</div>
                  </div>

                  <div class="print-barcode-container">
                      <svg id="${idBarcode}"></svg>
                  </div>
              `;
             
              currentPage.appendChild(cell);

              if (hCode !== 'NO-CODE') {
                  setTimeout(() => {
                      JsBarcode(`#${idBarcode}`, hCode, {
                          format: "CODE128", width: 1.8, height: 45, displayValue: true, fontSize: 13
                      });
                      new QRCode(document.getElementById(idQrcode), {
                          text: hCode, width: 75, height: 75, colorDark : "#000000", colorLight : "#ffffff"
                      });
                  }, 50);
              } else {
                  setTimeout(() => {
                      document.getElementById(idBarcode).style.display = "none";
                      document.getElementById(idQrcode).innerHTML = "<span style='font-size:0.9rem;color:#555;'>No Code</span>";
                  }, 50);
              }

              itemCount++;
          });

          document.body.classList.add('printing-a4');
         
          setTimeout(() => {
              window.print();
              setTimeout(() => {
                  document.body.classList.remove('printing-a4');
                  printContainer.style.display = "none";
              }, 1000);
          }, 500);
      }

  </script>
</body>
</html>